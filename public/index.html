<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Door Control System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .device-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .device-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .device-info p {
            margin: 5px 0;
        }

        .status-connected {
            color: #48bb78;
            font-weight: bold;
        }

        .status-disconnected {
            color: #f56565;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .status-info {
            background: #bee3f8;
            color: #1a365d;
            border: 1px solid #90cdf4;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .refresh-btn {
            background: #48bb78;
            margin-bottom: 15px;
        }

        .no-devices {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-style: italic;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .connected {
            background: #48bb78;
        }

        .disconnected {
            background: #f56565;
        }

        .last-updated {
            text-align: right;
            font-size: 0.8rem;
            color: #718096;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö™ Smart Door Control System</h1>
            <p>Monitor and control your ESP32 door access devices</p>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>üì± Connected Devices</h2>
                <div class="connection-status">
                    <span class="connection-dot" id="connection-dot"></span>
                    <span id="connection-status">Checking connection...</span>
                </div>
                
                <button class="btn refresh-btn" onclick="loadDevices()">
                    üîÑ Refresh Devices
                </button>
                
                <div id="devices-list">
                    <div class="loading">
                        <p>Loading devices...</p>
                    </div>
                </div>
                
                <div class="last-updated" id="last-updated"></div>
            </div>

            <div class="card">
                <h2>üìä System Status</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="device-count">0</div>
                        <div class="stat-label">Devices Online</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="room-count">0</div>
                        <div class="stat-label">Rooms</div>
                    </div>
                </div>

                <div id="status-message"></div>

                <h3 style="margin-top: 20px;">üîî Recent Activity</h3>
                <div id="recent-logs">
                    <p style="color: #718096; font-style: italic;">No recent activity</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üîß Manual Trigger</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="manual-device-id" placeholder="Enter device ID (e.g., ESP32_5ddaf380)" style="flex: 1; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                <button class="btn" onclick="triggerManualDevice()">
                    üöÄ Trigger Door
                </button>
            </div>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #718096;">
                Tip: Use device IDs from the connected devices list above
            </p>
        </div>
    </div>

    <script>
        let socket;
        let lastUpdateTime = null;

        // Initialize Socket.IO connection
        function initSocketIO() {
            socket = io({
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('‚úÖ Connected to server');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                console.log('‚ùå Disconnected from server');
            });

            socket.on('device_update', (data) => {
                console.log('üì± Device update received:', data);
                updateDeviceList(data.devices);
            });

            socket.on('log_update', (data) => {
                console.log('üìù Log update received:', data);
                addRecentLog(data);
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connection-dot');
            const status = document.getElementById('connection-status');
            
            if (connected) {
                dot.className = 'connection-dot connected';
                status.textContent = 'Connected to server';
                status.style.color = '#48bb78';
            } else {
                dot.className = 'connection-dot disconnected';
                status.textContent = 'Disconnected from server';
                status.style.color = '#f56565';
            }
        }

        // Load connected devices from API
        async function loadDevices() {
            const devicesList = document.getElementById('devices-list');
            
            try {
                devicesList.innerHTML = '<div class="loading"><p>Loading devices...</p></div>';
                
                const response = await fetch('/api/devices');
                const result = await response.json();
                
                if (result.success) {
                    updateDeviceList(result.devices);
                    updateLastUpdated();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                devicesList.innerHTML = `
                    <div class="status-error status-message">
                        ‚ùå Error loading devices: ${error.message}
                    </div>
                `;
            }
        }

        // Update device list in UI
        function updateDeviceList(devices) {
            const devicesList = document.getElementById('devices-list');
            const deviceCount = document.getElementById('device-count');
            
            deviceCount.textContent = devices.length;
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<div class="no-devices"><p>No devices connected</p></div>';
                return;
            }
            
            devicesList.innerHTML = devices.map(device => `
                <div class="device-card">
                    <h3>${device.roomName}</h3>
                    <div class="device-info">
                        <div>
                            <p><strong>Device ID:</strong> ${device.deviceId}</p>
                            <p><strong>Chip ID:</strong> ${device.chipId}</p>
                        </div>
                        <div>
                            <p><strong>IP Address:</strong> ${device.ip}</p>
                            <p><strong>Connected:</strong> ${formatTime(device.connectedAt)}</p>
                        </div>
                    </div>
                    <button class="btn" onclick="triggerDoor('${device.deviceId}')">
                        üîì Open Door
                    </button>
                </div>
            `).join('');
        }

        // Trigger door for a specific device
        async function triggerDoor(deviceId) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.innerHTML = `<div class="status-info status-message">Sending trigger command to ${deviceId}...</div>`;
            
            try {
                console.log(`üö™ Triggering door for device: ${deviceId}`);
                
                const response = await fetch(`/api/trigger/${encodeURIComponent(deviceId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        duration: 3000
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    statusMessage.innerHTML = `
                        <div class="status-success status-message">
                            ‚úÖ Door opened successfully for ${result.roomName || deviceId}
                        </div>
                    `;
                    console.log('‚úÖ Trigger successful:', result);
                } else {
                    statusMessage.innerHTML = `
                        <div class="status-error status-message">
                            ‚ùå Failed to trigger ${deviceId}: ${result.error}
                        </div>
                    `;
                    console.error('‚ùå Trigger failed:', result);
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
                statusMessage.innerHTML = `
                    <div class="status-error status-message">
                        ‚ùå Network error: ${error.message}
                    </div>
                `;
            }
            
            // Clear status message after 5 seconds
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Trigger door using manual device ID input
        function triggerManualDevice() {
            const deviceIdInput = document.getElementById('manual-device-id');
            const deviceId = deviceIdInput.value.trim();
            
            if (!deviceId) {
                alert('Please enter a device ID');
                return;
            }
            
            triggerDoor(deviceId);
            deviceIdInput.value = '';
        }

        // Add recent log to activity feed
        function addRecentLog(logData) {
            const recentLogs = document.getElementById('recent-logs');
            const logElement = document.createElement('div');
            logElement.className = 'status-info status-message';
            logElement.style.marginBottom = '10px';
            logElement.innerHTML = `
                <strong>${logData.roomName}</strong>: ${logData.action}
                <br><small>${formatTime(logData.timestamp)}</small>
            `;
            
            recentLogs.insertBefore(logElement, recentLogs.firstChild);
            
            // Keep only last 5 logs
            if (recentLogs.children.length > 5) {
                recentLogs.removeChild(recentLogs.lastChild);
            }
        }

        // Update last updated time
        function updateLastUpdated() {
            lastUpdateTime = new Date();
            const lastUpdatedElement = document.getElementById('last-updated');
            lastUpdatedElement.textContent = `Last updated: ${formatTime(lastUpdateTime)}`;
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString() + ' ' + date.toLocaleDateString();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initSocketIO();
            loadDevices();
            
            // Refresh devices every 10 seconds
            setInterval(loadDevices, 10000);
            
            // Load room count
            fetch('/api/rooms')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('room-count').textContent = result.rooms.length;
                    }
                })
                .catch(error => console.error('Error loading rooms:', error));
        });
    </script>
</body>
</html>
